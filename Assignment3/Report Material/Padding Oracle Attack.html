<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Padding Oracle Attack</title>

<link rel="stylesheet" href="Padding%20Oracle%20Attack_files/style.css" type="text/css">

<link rel="stylesheet" href="Padding%20Oracle%20Attack_files/local.css" type="text/css">


<link rel="alternate" type="application/x-wiki" title="Edit this page" href="https://not.burntout.org/ikiwiki.cgi?do=edit&amp;page=blog%2FPadding_Oracle_Attack">





</head>
<body>
<script src="Padding%20Oracle%20Attack_files/MathJax.html" type="text/javascript"></script>
<script src="Padding%20Oracle%20Attack_files/mathjax-config.js" type="text/javascript"></script>


<div class="page">

<div class="pageheader">
<div class="header">
<span>
<span class="parentlinks">

<a href="https://not.burntout.org/">not burntout</a>/ 

<a href="https://not.burntout.org/blog/">blog</a>/ 

</span>
<span class="title">
Padding Oracle Attack

</span>
</span>

</div>


<div class="navbar">
<ul>
<li><a href="https://not.burntout.org/about/"> About </a></li>
<li><a href="https://not.burntout.org/blog/"> Blog  </a></li>
</ul>
</div>




<div class="actions">
<ul>

<li><a href="https://not.burntout.org/ikiwiki.cgi?do=edit&amp;page=blog%2FPadding_Oracle_Attack" rel="nofollow">Edit</a></li>


<li><a href="https://not.burntout.org/recentchanges/">RecentChanges</a></li>




<li><a href="https://not.burntout.org/ikiwiki.cgi?do=prefs">Preferences</a></li>



<li><a rel="nofollow" href="https://not.burntout.org/ikiwiki.cgi?do=comment&amp;page=blog%2FPadding_Oracle_Attack">Comment</a></li>

</ul>
</div>







</div>


<div class="sidebar">
<h4 id="recentposts:">Recent Posts:</h4>

<div class="archivepage">

<a href="https://not.burntout.org/blog/using_tc_to_simulate_low_bandwidth_latency_and_jitter/">using tc to simulate low bandwidth latency and jitter</a><br>

<span class="archivepagedate">
Posted <span class="date">Tue 16 Sep 2014 17:07:51 BST</span>

</span>
</div>
<div class="archivepage">

<a href="https://not.burntout.org/blog/dnote-crypto/">dnote-crypto</a><br>

<span class="archivepagedate">
Posted <span class="date">Sat 14 Jun 2014 20:08:10 BST</span>

</span>
</div>
<div class="archivepage">

<a href="https://not.burntout.org/blog/high_performance_samba_server_on_freebsd/">high performance samba server on freebsd</a><br>

<span class="archivepagedate">
Posted <span class="date">Thu 08 May 2014 22:53:34 BST</span>

</span>
</div>
<div class="archivepage">

<a href="https://not.burntout.org/blog/infrastructure_as_code/">infrastructure as code</a><br>

<span class="archivepagedate">
Posted <span class="date">Fri 02 May 2014 12:09:46 BST</span>

</span>
</div>
<div class="archivepage">

<a href="https://not.burntout.org/blog/Padding_Oracle_Attack/">Padding Oracle Attack</a><br>

<span class="archivepagedate">
Posted <span class="date">Sat 01 Feb 2014 19:15:29 GMT</span>

</span>
</div>






<p><a href="https://not.burntout.org/archives/">Archives</a></p>

<p><a href="https://not.burntout.org/tags/">Tags</a>: </p><div class="pagecloud">
<span class="smallestPC"><a href="https://not.burntout.org/tags/android/">android</a></span>
<span class="normalPC"><a href="https://not.burntout.org/tags/crypto/">crypto</a></span>
<span class="biggestPC"><a href="https://not.burntout.org/tags/debian/">debian</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/debian/lenny/">lenny</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/exim/">exim</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/freebsd/">freebsd</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/hardware/">hardware</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/hp/">hp</a></span>
<span class="normalPC"><a href="https://not.burntout.org/tags/ikiwiki/">ikiwiki</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/ipsec/">ipsec</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/juniper/">juniper</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/linux/">linux</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/mathjax/">mathjax</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/mooc/">mooc</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/mrtg/">mrtg</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/network/">network</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/nginx/">nginx</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/openssl/">openssl</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/openwrt/">openwrt</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/performance/">performance</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/proliant/">proliant</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/python/">python</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/samba/">samba</a></span>
<span class="bigPC"><a href="https://not.burntout.org/tags/security/">security</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/shaping/">shaping</a></span>
<span class="normalPC"><a href="https://not.burntout.org/tags/smtp/">smtp</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/snmp/">snmp</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/ssl/">ssl</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/storage/">storage</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/strongswan/">strongswan</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/sysadmin/">sysadmin</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/tc/">tc</a></span>
<span class="smallPC"><a href="https://not.burntout.org/tags/tls/">tls</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/traffic/">traffic</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/wheezy/">wheezy</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/windows/">windows</a></span>
<span class="smallestPC"><a href="https://not.burntout.org/tags/zfs/">zfs</a></span>
</div><p></p>

</div>


<div id="pagebody">

<div id="content">
<h1 id="paddingoracleattacks">Padding Oracle attacks</h1>

<p>In network protocols it's generally good practice to send an 
meaningful error message to clients.  Examples from SMTP where one might
 see messages like "Unable to deliver because no such mailbox exists" 
help the sender realise that they have misaddressed an email, or an HTTP
 server might give a 404 error "Page not found" or a 401 error "Access 
Denied".</p>

<p>It turns out in cryptography that this is not such a good idea, and 
that leaking information about whether a block of cipher text is 
correctly padded or not can allows us to decrypt the whole of the text. 
There is a good wikipedia article here <a href="http://en.wikipedia.org/wiki/Padding_oracle">http://en.wikipedia.org/wiki/Padding_oracle</a></p>

<p><a name="more"></a></p>

<h2 id="padding">Padding</h2>

<p>Here is the definition of the PKCS7 padding function that <a href="http://en.wikipedia.org/wiki/Padding_%28cryptography%29#PKCS7">http://en.wikipedia.org/wiki/Padding_%28cryptography%29#PKCS7</a> which can be used in CBC mode cipher</p>

<p>The message is padded so it is a whole number of blocks. The value of
 the pad is the number of bytes that are required to be added.  If the 
message is already a whole number of blocks then we add another block of
 padding.</p>

<h3 id="example">Example</h3>

<p>The message "First Program is Hello World" is 28 bytes long.  This is
 gives 1 full 16 byte block ( used in AES128 ) and part block which 
requires padding.</p>

<pre><code>-----------------------------------------------------------------
| F | i | r | s | t |   | P | r | o | g | r | a | m |   | i | s |
-----------------------------------------------------------------
------------------------------------------------
|   | H | e | l | l | o |   | W | o | r | l | d | 
------------------------------------------------
</code></pre>

<p>So we pad it to a 16 byte block size by adding 4 bytes of 0x4 giving</p>

<pre><code>-----------------------------------------------------------------
| F | i | r | s | t |   | P | r | o | g | r | a | m |   | i | s |
-----------------------------------------------------------------
-----------------------------------------------------------------
|   | H | e | l | l | o |   | W | o | r | l | d |0x4|0x4|0x4|0x4|
-----------------------------------------------------------------
</code></pre>

<h2 id="cbcmodeencryption">CBC mode encryption</h2>

<p>The message is broken into several blocks ${m_i}$.  If the message is not an integer number of blocks we pad as described above.</p>

<p>Encryption is defined</p>

<p>$c_n=E(k,m_n \oplus c_{n-1})$</p>

<p>with $c_{-1}=IV$. $IV$ is an Initialisation Vector, $E(k,x)$ is a symmetric block cipher like AES or DES</p>

<p>Decryption is defined by </p>

<p>$m_n=D(k,c_n) \oplus c_{n-1}$</p>

<p>and we remove any padding on the last block.</p>

<h2 id="theattack">The Attack</h2>

<p>Note that in decryption we xor in the previous block of cipher text 
with the message plain text.  If we manipulate that, and a padding 
oracle tells us whether we have a valid pad or not; then we can decrypt 
the entire cipher text a byte at time.</p>

<h3 id="firstbyte">First byte</h3>

<p>We have two consecutive blocks of cipher text $c_{i-1}$, and $c_i$ </p>



<p>We guess that the last byte of the plaintext block $m_i$ is $g_i^{15}$</p>

<p>We submit the two blocks $ (c_{i-1} \oplus 000000000000000g_i^{15} \oplus 0000000000000001) || c_i $ to the padding oracle.</p>

<p>The padding oracle decrypts thus</p>

<p>$ D(k,c_i) \oplus  (c_{i-1} \oplus 000000000000000g_i^{15} \oplus 0000000000000001) $</p>

<p>And since </p>

<p>$ D(k,c_i) \oplus  c_{i-1} = m_i $</p>

<p>we get $ m_i \oplus 000000000000000g_i^{15} \oplus 0000000000000001 $ </p>

<p>If $g_i^{15}=m_i^{15}$ where $m_i^j$ is the jth byte of plaintext block $m_i$ </p>

<p>then </p>

<p>$ m_i \oplus 000000000000000g_i^{15} \oplus 0000000000000001 = 
m_{i}^0m_{i}^1m_{i}^2m_{i}^3m_{i}^4m_{i}^5m_{i}^6m_{i}^7m_{i}^8m_{i}^9m_{i}^{10}m_{i}^{11}m_{i}^{12}m_{i}^{13}m_{i}^{14}1$</p>

<p>Which has a valid pad, and our padding oracle will output true</p>

<h3 id="secondbyte">Second byte</h3>

<p>Now we have calculated the first byte we can repeat for the second byte</p>

<p>We submit $ (c_{i-1} \oplus 00000000000000g_i^{14}g_i^{15} \oplus 0000000000000022) || c_i $ to the padding oracle</p>

<p>Since  we already have $ g_i^{15}=m^{15}_i $ </p>

<p>the padding oracle outputs true if $g_i^{14}=m_i^{14}$</p>

<h3 id="thirdbyte">Third byte</h3>

<p>Similary for the third byte</p>

<p>We submit $ (c_{i-1} \oplus 0000000000000g_i^{13}g_i^{14}g_i^{15} \oplus 0000000000000333) || c_i $ to the padding oracle</p>

<p>Since we already have $ g_i^{15}=m_i^{15} $ and $g_i^{14}=m_i^{14}$</p>

<p>the padding oracle outputs true if $g_i^{13}=m_i^{13}$</p>

<h3 id="repeat">Repeat</h3>

<p>In this way we can decrypt each block a byte at a time, until we have
 all the plain text.  Each byte has only 256 possibilities, so we 
decrypt a block with at most $2^8$ guesses per byte</p>

<h2 id="example">Example</h2>

<p>The coursera.org cryptography course sets this as a test in one of 
the programming questions.  The oracle is available as a web service, 
and gives a 403 error if there is a bad pad, or a 404 error if the pad 
is correct, but the plaintext is wrong. </p>

<p>Here is <a href="https://not.burntout.org/blog/Padding_Oracle_Attack/programming-4.py">programming-4.py</a>
 my solution, it's quite fun to see the plaintext get discovered.  The 
code could be improved quite a lot. The managing of the padding is 
hamfisted, and the speed could be improved by guessing a smaller subset 
of characters.</p>

</div>



<div id="comments">




<div class="addcomment">
<a href="https://not.burntout.org/ikiwiki.cgi?do=comment&amp;page=blog%2FPadding_Oracle_Attack">Add a comment</a>
</div>

</div>



</div>

<div id="footer" class="pagefooter">

<div id="pageinfo">





<div class="tags">
Tags:

<a href="https://not.burntout.org/tags/crypto/" rel="tag">crypto</a>

<a href="https://not.burntout.org/tags/mooc/" rel="tag">mooc</a>

<a href="https://not.burntout.org/tags/python/" rel="tag">python</a>

</div>








<div class="pagedate">
Last edited <span class="date">Sat 01 Feb 2014 22:18:53 GMT</span>
<!-- Created <span class="date">Sat 01 Feb 2014 19:15:29 GMT</span> -->
</div>

</div>


<!-- from not burntout -->
</div>

</div>



</body></html>